<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rita i realtid</title>
    <link rel="manifest" href="manifest.json">
    <script type="module">
        // Importera Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getDatabase, ref, set, push, remove, onValue } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

        // Firebase-konfiguration
        const firebaseConfig = {
            apiKey: "AIzaSyBDMAPvvCb1MFFWgVb_8GTpQYwMSAR9uBU",
            authDomain: "mimminoah-ee32a.firebaseapp.com",
            databaseURL: "https://mimminoah-ee32a-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "mimminoah-ee32a",
            storageBucket: "mimminoah-ee32a.firebasestorage.app",
            messagingSenderId: "598999784847",
            appId: "1:598999784847:web:3de2bb39f019deeca27ffa"
        };

        // Initiera Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const drawingsRef = ref(db, "drawings");
        const usersRef = ref(db, "users");

        // Användare och färger
        const users = {
            "Noah": "#3498db",  // Blå
            "Mimmi": "#e91e63"  // Rosa
        };

        let user = null;
        let color = null;
        let drawnPixels = 0;
        const maxPixels = 6000; // Begränsning av ritade pixlar

        function selectUser() {
            document.body.innerHTML = "<h2>Vem är du?</h2>";
            Object.keys(users).forEach(name => {
                let btn = document.createElement("button");
                btn.textContent = name;
                btn.style.backgroundColor = users[name];
                btn.onclick = () => {
                    user = name;
                    color = users[name];
                    checkUser();
                };
                document.body.appendChild(btn);
            });
        }

        function checkUser() {
            onValue(usersRef, (snapshot) => {
                const data = snapshot.val() || {};
                if (Object.values(data).includes(user)) {
                    alert("Användaren är redan inloggad!");
                    location.reload();
                } else {
                    set(ref(db, `users/${user}`), user);
                    startCanvas();
                }
            });
        }

        function startCanvas() {
            document.body.innerHTML = `
                <div id="counter"></div>
                <button id="clear">Rensa mina ritningar</button>
                <canvas id="canvas"></canvas>
            `;

            // ** TIDSRÄKNARE **
            function updateCounter() {
                const startTime = new Date("2024-06-14T12:00:00Z");
                const now = new Date();
                const diff = now - startTime;
                
                const months = Math.floor(diff / (1000 * 60 * 60 * 24 * 30.44));
                const days = Math.floor(diff / (1000 * 60 * 60 * 24)) % 30;
                const hours = Math.floor(diff / (1000 * 60 * 60)) % 24;
                const minutes = Math.floor(diff / (1000 * 60)) % 60;
                const seconds = Math.floor(diff / 1000) % 60;

                document.getElementById("counter").innerText = 
                    `${months} månader, ${days} dagar, ${hours} timmar, ${minutes} minuter, ${seconds} sekunder`;
            }
            setInterval(updateCounter, 1000);
            updateCounter();

            // ** CANVAS RITNING **
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");

            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            resizeCanvas();
            window.addEventListener("resize", resizeCanvas);

            let drawing = false;
            let lastX, lastY;

            function startDrawing(e) {
                drawing = true;
                [lastX, lastY] = [e.clientX || e.touches[0].clientX, e.clientY || e.touches[0].clientY];
            }

            function stopDrawing() {
                drawing = false;
            }

            function draw(e) {
                if (!drawing || drawnPixels > maxPixels) return;

                const x = e.clientX || e.touches[0].clientX;
                const y = e.clientY || e.touches[0].clientY;

                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.lineWidth = 5;
                ctx.strokeStyle = color;
                ctx.lineCap = "round";
                ctx.stroke();

                drawnPixels += Math.sqrt((x - lastX) ** 2 + (y - lastY) ** 2);
                [lastX, lastY] = [x, y];

                // Spara till Firebase
                push(drawingsRef, { x, y, color, user });

                // Radera gamla ritningar om maxgränsen nås
                if (drawnPixels > maxPixels) {
                    onValue(drawingsRef, (snapshot) => {
                        const keys = Object.keys(snapshot.val() || {});
                        remove(ref(db, `drawings/${keys[0]}`));
                    }, { onlyOnce: true });
                }
            }

            canvas.addEventListener("mousedown", startDrawing);
            canvas.addEventListener("mousemove", draw);
            canvas.addEventListener("mouseup", stopDrawing);
            canvas.addEventListener("mouseleave", stopDrawing);
            canvas.addEventListener("touchstart", startDrawing);
            canvas.addEventListener("touchmove", draw);
            canvas.addEventListener("touchend", stopDrawing);

            // ** LADDA RITNINGAR I REALTID **
            onValue(drawingsRef, (snapshot) => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                snapshot.forEach((child) => {
                    const { x, y, color } = child.val();
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, Math.PI * 2);
                    ctx.fillStyle = color;
                    ctx.fill();
                });
            });

            // ** RENSNING AV EGNA RITNINGAR **
            document.getElementById("clear").addEventListener("click", () => {
                onValue(drawingsRef, (snapshot) => {
                    snapshot.forEach((child) => {
                        if (child.val().user === user) {
                            remove(ref(db, `drawings/${child.key}`));
                        }
                    });
                }, { onlyOnce: true });
            });

            // ** AUTOMATISK RENSNING EFTER 24 TIMMAR **
            setInterval(() => {
                onValue(drawingsRef, (snapshot) => {
                    snapshot.forEach((child) => {
                        if (Date.now() - child.val().timestamp > 86400000) {
                            remove(ref(db, `drawings/${child.key}`));
                        }
                    });
                });
            }, 60000);
        }

        selectUser();
    </script>
    <style>
        body { margin: 0; overflow: hidden; text-align: center; }
        canvas { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; }
        button { margin: 10px; padding: 10px; font-size: 16px; cursor: pointer; }
        #counter { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); font-size: 18px; font-weight: bold; }
    </style>
</head>
<body>
</body>
</html>