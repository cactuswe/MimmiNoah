

<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rita i realtid</title>
    <link rel="manifest" href="manifest.json">
    <script type="module">
        // Importera Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, remove } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

        // Firebase-konfiguration
        const firebaseConfig = {
            apiKey: "AIzaSyBDMAPvvCb1MFFWgVb_8GTpQYwMSAR9uBU",
            authDomain: "mimminoah-ee32a.firebaseapp.com",
            databaseURL: "https://mimminoah-ee32a-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "mimminoah-ee32a",
            storageBucket: "mimminoah-ee32a.firebasestorage.app",
            messagingSenderId: "598999784847",
            appId: "1:598999784847:web:3de2bb39f019deeca27ffa"
        };

        // Initiera Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const drawingsRef = ref(db, "drawings");
        const colorsRef = ref(db, "colors");

        // Tillgängliga färger
        const availableColors = ["#FF0000", "#00FF00", "#0000FF", "#FFFF00", "#FF00FF", "#00FFFF", "#FFA500", "#800080", "#008000", "#000000"];
        let selectedColor = localStorage.getItem("selectedColor");

        async function chooseColor() {
            const snapshot = await fetchColors();
            const takenColors = Object.values(snapshot || {});

            // Skapa färgvalsknappar
            document.body.innerHTML = "<h2>Välj en färg</h2>";
            availableColors.forEach(color => {
                if (!takenColors.includes(color)) {
                    let btn = document.createElement("button");
                    btn.style.backgroundColor = color;
                    btn.style.width = "50px";
                    btn.style.height = "50px";
                    btn.style.border = "none";
                    btn.style.margin = "5px";
                    btn.onclick = () => {
                        selectedColor = color;
                        localStorage.setItem("selectedColor", color);
                        push(colorsRef, color);
                        startCanvas();
                    };
                    document.body.appendChild(btn);
                }
            });
        }

        async function fetchColors() {
            return new Promise(resolve => {
                onValue(colorsRef, (snapshot) => {
                    resolve(snapshot.val());
                });
            });
        }

        function startCanvas() {
            document.body.innerHTML = ""; // Rensa sidan

            // Skapa canvas
            const canvas = document.createElement("canvas");
            document.body.appendChild(canvas);
            const ctx = canvas.get

            const ctx = canvas.getContext("2d");
            let drawing = false;
            let lastX = 0;
            let lastY = 0;
            let color = selectedColor;

            // Anpassa canvas till skärmen
            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            resizeCanvas();
            window.addEventListener("resize", resizeCanvas);

            // Ritningsfunktioner
            function startDrawing(e) {
                drawing = true;
                lastX = e.touches ? e.touches[0].clientX : e.clientX;
                lastY = e.touches ? e.touches[0].clientY : e.clientY;
            }

            function stopDrawing() {
                drawing = false;
            }

            function draw(e) {
                if (!drawing) return;

                let x = e.touches ? e.touches[0].clientX : e.clientX;
                let y = e.touches ? e.touches[0].clientY : e.clientY;

                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.lineWidth = 5;
                ctx.strokeStyle = color;
                ctx.lineCap = "round";
                ctx.stroke();

                lastX = x;
                lastY = y;

                // Skicka data till Firebase
                push(drawingsRef, {
                    x, y, color,
                    timestamp: Date.now()
                });
            }

            // Event listeners för ritning
            canvas.addEventListener("mousedown", startDrawing);
            canvas.addEventListener("mousemove", draw);
            canvas.addEventListener("mouseup", stopDrawing);
            canvas.addEventListener("touchstart", startDrawing);
            canvas.addEventListener("touchmove", draw);
            canvas.addEventListener("touchend", stopDrawing);

            // Hämta data i realtid
            onValue(drawingsRef, (snapshot) => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                snapshot.forEach((child) => {
                    const { x, y, color } = child.val();
                    ctx.beginPath();
                    ctx.arc(x, y, 5, 0, Math.PI * 2);
                    ctx.fillStyle = color;
                    ctx.fill();
                });
            });

            // Automatisk rensning av ritningar efter 24 timmar
            setInterval(() => {
                onValue(drawingsRef, (snapshot) => {
                    snapshot.forEach((child) => {
                        if (Date.now() - child.val().timestamp > 24 * 60 * 60 * 1000) {
                            remove(ref(db, "drawings/" + child.key));
                        }
                    });
                });
            }, 60000); // Kör rensningen varje minut
        }

        // Om användaren redan har valt färg, starta canvas direkt
        if (selectedColor) {
            startCanvas();
        } else {
            // Annars visa färgval
            chooseColor();
        }
    </script>
    <style>
        body { margin: 0; overflow: hidden; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        canvas { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; }
        button { cursor: pointer; }
    </style>
</head>
<body>
</body>
</html>