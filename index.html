<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rita i realtid</title>
    <link rel="manifest" href="manifest.json">
    <script type="module">
        // Importera Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, remove } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

        // Firebase-konfiguration
        const firebaseConfig = {
            apiKey: "AIzaSyBDMAPvvCb1MFFWgVb_8GTpQYwMSAR9uBU",
            authDomain: "mimminoah-ee32a.firebaseapp.com",
            databaseURL: "https://mimminoah-ee32a-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "mimminoah-ee32a",
            storageBucket: "mimminoah-ee32a.firebasestorage.app",
            messagingSenderId: "598999784847",
            appId: "1:598999784847:web:3de2bb39f019deeca27ffa"
        };

        // Initiera Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const drawingsRef = ref(db, "drawings");
        const colorsRef = ref(db, "colors");

        // Definiera färger
        const colors = {
            noah: "#1E90FF", // Blå färg för Noah
            mimmi: "#FFB6C1" // Pastellfärg för Mimmi
        };

        let selectedUser = localStorage.getItem("selectedUser");
        let selectedColor = localStorage.getItem("selectedColor");

        // Välj användare och färg
        function chooseUser() {
            document.body.innerHTML = "<h2>Vem är du?</h2>";
            const noahButton = document.createElement("button");
            noahButton.textContent = "Noah";
            noahButton.style.backgroundColor = colors.noah;
            noahButton.onclick = () => {
                selectedUser = "noah";
                selectedColor = colors.noah;
                localStorage.setItem("selectedUser", selectedUser);
                localStorage.setItem("selectedColor", selectedColor);
                push(colorsRef, { [selectedUser]: selectedColor });
                startCanvas();
            };

            const mimmiButton = document.createElement("button");
            mimmiButton.textContent = "Mimmi";
            mimmiButton.style.backgroundColor = colors.mimmi;
            mimmiButton.onclick = () => {
                selectedUser = "mimmi";
                selectedColor = colors.mimmi;
                localStorage.setItem("selectedUser", selectedUser);
                localStorage.setItem("selectedColor", selectedColor);
                push(colorsRef, { [selectedUser]: selectedColor });
                startCanvas();
            };

            document.body.appendChild(noahButton);
            document.body.appendChild(mimmiButton);
        }

        // Starta ritningen
        function startCanvas() {
            document.body.innerHTML = ""; // Rensa sidan

            // Skapa canvas
            const canvas = document.createElement("canvas");
            document.body.appendChild(canvas);
            const ctx = canvas.getContext("2d");

            let drawing = false;
            let lastX = 0;
            let lastY = 0;
            let points = [];
            const color = selectedColor;

            // Anpassa canvas till skärmen
            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            resizeCanvas();
            window.addEventListener("resize", resizeCanvas);

            // Ritningsfunktioner
            function startDrawing(e) {
                drawing = true;
                lastX = e.touches ? e.touches[0].clientX : e.clientX;
                lastY = e.touches ? e.touches[0].clientY : e.clientY;
                points = [{ x: lastX, y: lastY }];
            }

            function stopDrawing() {
                drawing = false;
                if (points.length > 1) {
                    push(drawingsRef, {
                        user: selectedUser,
                        points,
                        color,
                        timestamp: Date.now()
                    });
                }
            }

            function draw(e) {
                if (!drawing) return;

                let x = e.touches ? e.touches[0].clientX : e.clientX;
                let y = e.touches ? e.touches[0].clientY : e.clientY;
                points.push({ x, y });

                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.lineWidth = 5;
                ctx.strokeStyle = color;
                ctx.lineCap = "round";
                ctx.stroke();

                lastX = x;
                lastY = y;
            }

            // Event listeners för ritning
            canvas.addEventListener("mousedown", startDrawing);
            canvas.addEventListener("mousemove", draw);
            canvas.addEventListener("mouseup", stopDrawing);
            canvas.addEventListener("touchstart", startDrawing);
            canvas.addEventListener("touchmove", draw);
            canvas.addEventListener("touchend", stopDrawing);

            // Hämta data i realtid
            onValue(drawingsRef, (snapshot) => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                snapshot.forEach((child) => {
                    const { points, color } = child.val();
                    ctx.beginPath();
                    points.forEach((point, index) => {
                        if (index === 0) {
                            ctx.moveTo(point.x, point.y);
                        } else {
                            ctx.lineTo(point.x, point.y);
                        }
                    });
                    ctx.lineWidth = 5;
                    ctx.strokeStyle = color;
                    ctx.lineCap = "round";
                    ctx.stroke();
                });
            });

            // Automatisk rensning av ritningar efter 24 timmar
            setInterval(() => {
                onValue(drawingsRef, (snapshot) => {
                    snapshot.forEach((child) => {
                        if (Date.now() - child.val().timestamp > 24 * 60 * 60 * 1000) {
                            remove(ref(db, "drawings/" + child.key));
                        }
                    });
                });
            }, 60000); // Kör rensningen varje minut
        }

        // Om användaren redan har valt användare, starta canvas direkt
        if (selectedUser && selectedColor) {
            startCanvas();
        } else {
            // Annars visa användarval
            chooseUser();
        }
    </script>
    <style>
        body { margin: 0; overflow: hidden; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        canvas { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; }
        button { cursor: pointer; margin: 5px; padding: 10px 20px; font-size: 18px; border: none; color: white; }
    </style>
</head>
<body>
</body>
</html>