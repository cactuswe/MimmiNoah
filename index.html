<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rita i realtid</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, remove } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBDMAPvvCb1MFFWgVb_8GTpQYwMSAR9uBU",
            authDomain: "mimminoah-ee32a.firebaseapp.com",
            databaseURL: "https://mimminoah-ee32a-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "mimminoah-ee32a",
            storageBucket: "mimminoah-ee32a.firebasestorage.app",
            messagingSenderId: "598999784847",
            appId: "1:598999784847:web:3de2bb39f019deeca27ffa"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const drawingsRef = ref(db, "drawings");
        const colorsRef = ref(db, "colors");

        const colors = {
            noah: "#1E90FF",
            mimmi: "#FFB6C1"
        };

        let selectedUser = localStorage.getItem("selectedUser");
        let selectedColor = localStorage.getItem("selectedColor");

        function chooseUser() {
            document.body.innerHTML = "<h2>Vem är du?</h2>";
            const noahButton = document.createElement("button");
            noahButton.textContent = "Noah";
            noahButton.style.backgroundColor = colors.noah;
            noahButton.onclick = () => {
                selectedUser = "noah";
                selectedColor = colors.noah;
                localStorage.setItem("selectedUser", selectedUser);
                localStorage.setItem("selectedColor", selectedColor);
                push(colorsRef, { [selectedUser]: selectedColor });
                startCanvas();
            };

            const mimmiButton = document.createElement("button");
            mimmiButton.textContent = "Mimmi";
            mimmiButton.style.backgroundColor = colors.mimmi;
            mimmiButton.onclick = () => {
                selectedUser = "mimmi";
                selectedColor = colors.mimmi;
                localStorage.setItem("selectedUser", selectedUser);
                localStorage.setItem("selectedColor", selectedColor);
                push(colorsRef, { [selectedUser]: selectedColor });
                startCanvas();
            };

            document.body.appendChild(noahButton);
            document.body.appendChild(mimmiButton);
        }

        function startCanvas() {
            document.body.innerHTML = "";
            const canvas = document.createElement("canvas");
            document.body.appendChild(canvas);
            const ctx = canvas.getContext("2d");

            let drawing = false;
            let lastX = 0;
            let lastY = 0;
            let points = [];
            let lineWidth = 5;
            const color = selectedColor;
            let totalLength = 0;

            const MAX_LENGTH = 1000; // Max längd innan gamla linjer raderas

            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            resizeCanvas();
            window.addEventListener("resize", resizeCanvas);

            const sizeControl = document.createElement("input");
            sizeControl.type = "range";
            sizeControl.min = 1;
            sizeControl.max = 20;
            sizeControl.value = lineWidth;
            sizeControl.style.position = "absolute";
            sizeControl.style.top = "10px";
            sizeControl.style.left = "10px";
            sizeControl.addEventListener("input", (e) => {
                lineWidth = e.target.value;
            });
            document.body.appendChild(sizeControl);

            const clearButton = document.createElement("button");
            clearButton.textContent = "Ta bort mina ritningar";
            clearButton.style.position = "absolute";
            clearButton.style.top = "10px";
            clearButton.style.left = "100px";
            clearButton.onclick = () => {
                const userDrawingsRef = ref(db, `drawings/${selectedUser}`);
                remove(userDrawingsRef);
            };
            document.body.appendChild(clearButton);

            function startDrawing(e) {
                drawing = true;
                lastX = e.touches ? e.touches[0].clientX : e.clientX;
                lastY = e.touches ? e.touches[0].clientY : e.clientY;
                points = [{ x: lastX, y: lastY }];
            }

            function stopDrawing() {
                drawing = false;
                if (points.length > 1) {
                    push(drawingsRef, {
                        user: selectedUser,
                        points,
                        color,
                        lineWidth,
                        timestamp: Date.now()
                    });
                }
            }

            function draw(e) {
                if (!drawing) return;

                let x = e.touches ? e.touches[0].clientX : e.clientX;
                let y = e.touches ? e.touches[0].clientY : e.clientY;
                points.push({ x, y });

                // Beräkna längd på ritningen
                const dx = x - lastX;
                const dy = y - lastY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                totalLength += distance;

                // Om längden överskrider MAX_LENGTH, ta bort gamla linjer
                if (totalLength > MAX_LENGTH) {
                    removeOldDrawings();
                }

                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.lineWidth = lineWidth;
                ctx.strokeStyle = color;
                ctx.lineCap = "round";
                ctx.stroke();

                lastX = x;
                lastY = y;
            }

            function removeOldDrawings() {
                onValue(drawingsRef, (snapshot) => {
                    let drawingsToRemove = [];
                    snapshot.forEach((child) => {
                        const points = child.val().points;
                        let length = 0;
                        for (let i = 1; i < points.length; i++) {
                            const dx = points[i].x - points[i - 1].x;
                            const dy = points[i].y - points[i - 1].y;
                            length += Math.sqrt(dx * dx + dy * dy);
                        }
                        if (length > MAX_LENGTH) {
                            drawingsToRemove.push(child.key);
                        }
                    });

                    drawingsToRemove.forEach((key) => {
                        remove(ref(db, `drawings/${key}`));
                    });
                });
            }

            canvas.addEventListener("mousedown", startDrawing);
            canvas.addEventListener("mousemove", draw);
            canvas.addEventListener("mouseup", stopDrawing);
            canvas.addEventListener("touchstart", startDrawing);
            canvas.addEventListener("touchmove", draw);
            canvas.addEventListener("touchend", stopDrawing);

            onValue(drawingsRef, (snapshot) => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                snapshot.forEach((child) => {
                    const { points, color, lineWidth } = child.val();
                    if (child.val().user !== selectedUser) return;
                    ctx.beginPath();
                    points.forEach((point, index) => {
                        if (index === 0) {
                            ctx.moveTo(point.x, point.y);
                        } else {
                            ctx.lineTo(point.x, point.y);
                        }
                    });
                    ctx.lineWidth = lineWidth;
                    ctx.strokeStyle = color;
                    ctx.lineCap = "round";
                    ctx.stroke();
                });
            });
        }

        if (selectedUser && selectedColor) {
            startCanvas();
        } else {
            chooseUser();
        }
    </script>
    <style>
        body { margin: 0; overflow: hidden; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        canvas { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; }
        button { cursor: pointer; margin: 5px; padding: 10px 20px; font-size: 18px; border: none; color: white; }
        input[type="range"] { margin: 10px; }
    </style>
</head>
<body>
</body>
</html>