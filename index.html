<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rita i realtid</title>
    <link rel="manifest" href="manifest.json">
    <script type="module">
        // Importera Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getDatabase, ref, push, remove, onValue } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

        // Firebase-konfiguration
        const firebaseConfig = {
            apiKey: "AIzaSyBDMAPvvCb1MFFWgVb_8GTpQYwMSAR9uBU",
            authDomain: "mimminoah-ee32a.firebaseapp.com",
            databaseURL: "https://mimminoah-ee32a-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "mimminoah-ee32a",
            storageBucket: "mimminoah-ee32a.firebasestorage.app",
            messagingSenderId: "598999784847",
            appId: "1:598999784847:web:3de2bb39f019deeca27ffa"
        };

        // Initiera Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const drawingsRef = ref(db, "drawings");

        let user = localStorage.getItem("user");
        let color = "";
        const colors = { "Noah": "#FF5733", "Mimmi": "#A569BD" };
        let totalDrawnPixels = 0;
        const maxPixels = 10000;

        function chooseUser() {
            document.body.innerHTML = "<h2>Vem är du?</h2>";
            ["Noah", "Mimmi"].forEach(name => {
                let btn = document.createElement("button");
                btn.textContent = name;
                btn.style.backgroundColor = colors[name];
                btn.style.width = "100px";
                btn.style.height = "50px";
                btn.style.margin = "10px";
                btn.onclick = () => {
                    localStorage.setItem("user", name);
                    user = name;
                    color = colors[name];
                    startCanvas();
                };
                document.body.appendChild(btn);
            });
        }

        function startCanvas() {
            document.body.innerHTML = `
                <div id="counter"></div>
                <button id="clearBtn">Rensa</button>
                <canvas id="canvas"></canvas>
            `;

            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");
            const clearBtn = document.getElementById("clearBtn");

            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            resizeCanvas();
            window.addEventListener("resize", resizeCanvas);

            let drawing = false;
            let lastX = 0, lastY = 0;

            function startDrawing(e) {
                drawing = true;
                [lastX, lastY] = [e.clientX || e.touches[0].clientX, e.clientY || e.touches[0].clientY];
            }

            function stopDrawing() {
                drawing = false;
            }

            function draw(e) {
                if (!drawing || totalDrawnPixels > maxPixels) return;

                let x = e.clientX || e.touches[0].clientX;
                let y = e.clientY || e.touches[0].clientY;
                ctx.strokeStyle = color;
                ctx.lineWidth = 5;
                ctx.lineCap = "round";

                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();

                push(drawingsRef, { x, y, user, color, timestamp: Date.now() });

                totalDrawnPixels += Math.hypot(x - lastX, y - lastY);
                if (totalDrawnPixels > maxPixels) cleanOldDrawings();

                [lastX, lastY] = [x, y];
            }

            function cleanOldDrawings() {
                onValue(drawingsRef, (snapshot) => {
                    let keys = Object.keys(snapshot.val() || {});
                    if (keys.length > 10) remove(ref(db, `drawings/${keys[0]}`));
                });
            }

            function clearDrawings() {
                onValue(drawingsRef, (snapshot) => {
                    snapshot.forEach((child) => {
                        if (child.val().user === user) remove(ref(db, `drawings/${child.key}`));
                    });
                });
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                totalDrawnPixels = 0;
            }

            canvas.addEventListener("mousedown", startDrawing);
            canvas.addEventListener("mousemove", draw);
            canvas.addEventListener("mouseup", stopDrawing);
            canvas.addEventListener("touchstart", startDrawing);
            canvas.addEventListener("touchmove", draw);
            canvas.addEventListener("touchend", stopDrawing);
            clearBtn.addEventListener("click", clearDrawings);

            onValue(drawingsRef, (snapshot) => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                snapshot.forEach((child) => {
                    const { x, y, color } = child.val();
                    ctx.fillStyle = color;
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, Math.PI * 2);
                    ctx.fill();
                });
            });

            function updateCounter() {
                const startDate = new Date("2024-06-14T12:00:00Z");
                const now = new Date();
                const diff = now - startDate;
                const months = Math.floor(diff / (1000 * 60 * 60 * 24 * 30));
                const days = Math.floor(diff / (1000 * 60 * 60 * 24) % 30);
                const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
                const minutes = Math.floor((diff / (1000 * 60)) % 60);
                document.getElementById("counter").innerText = `${months} mån, ${days} dagar, ${hours}h, ${minutes}m`;
            }
            setInterval(updateCounter, 60000);
            updateCounter();
        }

        user ? startCanvas() : chooseUser();
    </script>
    <style>
        body { margin: 0; overflow: hidden; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        canvas { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; }
        button { position: fixed; bottom: 10px; padding: 10px 20px; background: #333; color: white; border: none; border-radius: 5px; cursor: pointer; }
        #counter { position: fixed; top: 10px; color: white; font-size: 18px; }
    </style>
</head>
<body>
</body>
</html>